<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø§Ø²Ù† Ø§Ù„ÙƒØ§Ø¨Ù„Ø§Øª</title>
    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-input: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --primary: #10b981;
            --primary-hover: #059669;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --border: #333333;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        .navbar {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            height: 60px;
            gap: 0.5rem;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .nav-inner::-webkit-scrollbar { display: none; }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 1rem;
            font-family: inherit;
            border-radius: 0.5rem;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }

        .nav-btn.active {
            background-color: var(--primary);
            color: #fff;
            font-weight: bold;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
            width: 100%;
            flex: 1;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Components */
        .card {
            background-color: var(--bg-card);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            position: relative;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1, h2, h3 { font-weight: 600; color: var(--text-main); }
        h1 { font-size: 1.5rem; }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s, opacity 0.2s;
            font-family: inherit;
        }

        .btn:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover:not(:disabled) { background-color: rgba(255, 255, 255, 0.05); }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        /* Forms */
        .form-group { margin-bottom: 1rem; }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            color: var(--text-main);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .grid-2 { grid-template-columns: 1fr 1fr; }
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .search-bar input { flex: 1; min-width: 200px; }
        .search-bar select { width: auto; min-width: 120px; }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            position: relative;
            min-height: 100px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            min-width: 600px;
        }

        th, td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: rgba(255, 255, 255, 0.02);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: rgba(255, 255, 255, 0.02); }

        /* Badges */
        .badge {
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }
        .badge-cu { background-color: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-al { background-color: rgba(148, 163, 184, 0.15); color: #cbd5e1; border: 1px solid rgba(148, 163, 184, 0.3); }
        .badge-status-low { background-color: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-status-ok { background-color: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            padding: 1rem;
        }

        .modal-overlay.open { display: flex; }

        .modal {
            background-color: var(--bg-card);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 2000;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
        }
        
        .toast.success { border-right: 4px solid var(--primary); }
        .toast.error { border-right: 4px solid var(--danger); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes toastOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            width: 1rem;
            height: 1rem;
            top: 50%;
            left: 50%;
            margin-left: -0.5rem;
            margin-top: -0.5rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Print Styles */
        @media print {
            .navbar, .btn, .no-print, .search-bar, .toast-container { display: none !important; }
            body { background: white; color: black; display: block; }
            .card { border: none; box-shadow: none; padding: 0; margin: 0; }
            .container { padding: 0; max-width: 100%; }
            table { border: 1px solid #000; font-size: 11pt; width: 100%; }
            th, td { border: 1px solid #000; padding: 5px; color: black; text-align: center; }
            th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
            .section { display: none; }
            #report-print-area { display: block !important; }
            #printDateDisplay { display: block !important; font-size: 1.2rem; margin-bottom: 1rem; }
            .badge { border: 1px solid #000; color: #000; background: none !important; }
        }
    </style>
</head>
<body>

    <!-- Datalist for sizes -->
    <datalist id="sizeSuggestions">
        <option value="1 Ù…Ù…">
        <option value="1.5 Ù…Ù…">
        <option value="2.5 Ù…Ù…">
        <option value="4 Ù…Ù…">
        <option value="6 Ù…Ù…">
        <option value="10 Ù…Ù…">
        <option value="16 Ù…Ù…">
        <option value="25 Ù…Ù…">
        <option value="35 Ù…Ù…">
        <option value="50 Ù…Ù…">
        <option value="70 Ù…Ù…">
        <option value="95 Ù…Ù…">
        <option value="120 Ù…Ù…">
        <option value="150 Ù…Ù…">
        <option value="185 Ù…Ù…">
        <option value="240 Ù…Ù…">
    </datalist>

    <nav class="navbar">
        <div class="nav-inner">
            <button class="nav-btn active" onclick="app.switchTab('benzina')">Ù…Ø®Ø²Ù† Ø¨Ù†Ø²ÙŠÙ†Ù‡</button>
            <button class="nav-btn" onclick="app.switchTab('new')">Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯</button>
            <button class="nav-btn" onclick="app.switchTab('hajj')">Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø¬</button>
            <button class="nav-btn" onclick="app.switchTab('issues')">Ø¥ØµØ¯Ø§Ø±Ø§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ±</button>
        </div>
    </nav>

    <div class="container">
        <!-- Warehouse 1: Benzina -->
        <div id="benzina" class="section active">
            <div class="header-row">
                <h1>Ù…Ø®Ø²Ù† Ø¨Ù†Ø²ÙŠÙ†Ù‡</h1>
                <button class="btn" onclick="app.openAddModal('Ù…Ø®Ø²Ù† Ø¨Ù†Ø²ÙŠÙ†Ù‡')">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
            </div>
            <div class="card">
                <div class="search-bar">
                    <input type="text" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." onkeyup="app.filterTable('benzina')">
                    <select onchange="app.filterTable('benzina')">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                        <option value="Ù†Ø­Ø§Ø³">Ù†Ø­Ø§Ø³</option>
                        <option value="Ø£Ù„Ù…Ù†ÙŠÙˆÙ…">Ø£Ù„Ù…Ù†ÙŠÙˆÙ…</option>
                        <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±</option>
                    </select>
                </div>
                <div class="table-responsive">
                    <div id="loader-benzina" class="loading-spinner"></div>
                    <table id="table-benzina">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ù…Ù‚Ø§Ø³</th>
                                <th>Ø§Ù„Ø£Ù…ØªØ§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Warehouse 2: New -->
        <div id="new" class="section">
            <div class="header-row">
                <h1>Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯</h1>
                <button class="btn" onclick="app.openAddModal('Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯')">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
            </div>
            <div class="card">
                <div class="search-bar">
                    <input type="text" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." onkeyup="app.filterTable('new')">
                    <select onchange="app.filterTable('new')">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                        <option value="Ù†Ø­Ø§Ø³">Ù†Ø­Ø§Ø³</option>
                        <option value="Ø£Ù„Ù…Ù†ÙŠÙˆÙ…">Ø£Ù„Ù…Ù†ÙŠÙˆÙ…</option>
                        <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±</option>
                    </select>
                </div>
                <div class="table-responsive">
                    <div id="loader-new" class="loading-spinner"></div>
                    <table id="table-new">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ù…Ù‚Ø§Ø³</th>
                                <th>Ø§Ù„Ø£Ù…ØªØ§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Warehouse 3: Al-Hajj -->
        <div id="hajj" class="section">
            <div class="header-row">
                <h1>Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø¬</h1>
                <button class="btn" onclick="app.openAddModal('Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø¬')">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
            </div>
            <div class="card">
                <div class="search-bar">
                    <input type="text" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." onkeyup="app.filterTable('hajj')">
                    <select onchange="app.filterTable('hajj')">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                        <option value="Ù†Ø­Ø§Ø³">Ù†Ø­Ø§Ø³</option>
                        <option value="Ø£Ù„Ù…Ù†ÙŠÙˆÙ…">Ø£Ù„Ù…Ù†ÙŠÙˆÙ…</option>
                        <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±</option>
                    </select>
                </div>
                <div class="table-responsive">
                    <div id="loader-hajj" class="loading-spinner"></div>
                    <table id="table-hajj">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ù…Ù‚Ø§Ø³</th>
                                <th>Ø§Ù„Ø£Ù…ØªØ§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Issues & Reports -->
        <div id="issues" class="section">
            <div class="header-row">
                <h1>Ø¥ØµØ¯Ø§Ø±Ø§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ±</h1>
            </div>

            <div class="card no-print">
                <h3 style="margin-bottom: 1rem;">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ØµØ±Ù Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <form id="issueForm" onsubmit="app.handleIssueSubmit(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø®Ø²Ù†</label>
                            <select id="issueWarehouse" onchange="app.updateIssueItems()" required>
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø²Ù† --</option>
                                <option value="Ù…Ø®Ø²Ù† Ø¨Ù†Ø²ÙŠÙ†Ù‡">Ù…Ø®Ø²Ù† Ø¨Ù†Ø²ÙŠÙ†Ù‡</option>
                                <option value="Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯">Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯</option>
                                <option value="Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø¬">Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø¬</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ±Ù</label>
                            <input type="date" id="issueDate" required>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Ø§Ù„ØµÙ†Ù</label>
                            <select id="issueItemSelect" required disabled>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø²Ù† Ø£ÙˆÙ„Ø§Ù‹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…ØªØ±)</label>
                            <input type="number" id="issueAmount" min="0.1" step="0.1" required disabled>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                        <input type="text" id="issueRecipient" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…">
                    </div>

                    <div style="text-align: left;">
                        <button type="submit" class="btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµØ±Ù</button>
                    </div>
                </form>
            </div>

            <div id="report-print-area">
                <div class="header-row no-print" style="margin-top: 2rem;">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="date" id="reportDate" onchange="app.renderReport()" style="width: auto;">
                        <button class="btn btn-outline" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                    </div>
                </div>

                <!-- Print Header -->
                <div style="display: none;" id="printDateDisplay"></div>

                <div class="card" style="box-shadow: none; padding: 0;">
                    <div id="loader-report" class="loading-spinner"></div>
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
                                <th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                                <th>Ø§Ù„ØµÙ†Ù</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØµØ±ÙØ©</th>
                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody"></tbody>
                        <tfoot>
                            <tr style="background-color: var(--bg-input); font-weight: bold;">
                                <td colspan="3" style="text-align: center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                <td id="reportTotal" style="text-align: center;">0 Ù…ØªØ±</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Add Modal -->
    <div id="addModal" class="modal-overlay">
        <div class="modal">
            <h2 style="margin-bottom: 1.5rem;">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h2>
            <form id="addForm" onsubmit="app.handleAddSubmit(event)">
                <input type="hidden" id="targetWarehouse">
                
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ù„Ùƒ</label>
                    <select id="addType" required>
                        <option value="Ù†Ø­Ø§Ø³">Ù†Ø­Ø§Ø³</option>
                        <option value="Ø£Ù„Ù…Ù†ÙŠÙˆÙ…">Ø£Ù„Ù…Ù†ÙŠÙˆÙ…</option>
                        <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ù‚Ø§Ø³ (Ø§Ù„Ø§Ø³Ù…)</label>
                    <input type="text" id="addSize" list="sizeSuggestions" placeholder="Ù…Ø«Ø§Ù„: 16 Ù…Ù…" required>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…ØªØ±)</label>
                    <input type="number" id="addMeters" min="0" step="0.1" required>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-outline" onclick="app.closeModal('addModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <h2 style="margin-bottom: 1.5rem;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù</h2>
            <form id="editForm" onsubmit="app.handleEditSubmit(event)">
                <input type="hidden" id="editWarehouse">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ù„Ùƒ</label>
                    <select id="editType" required>
                        <option value="Ù†Ø­Ø§Ø³">Ù†Ø­Ø§Ø³</option>
                        <option value="Ø£Ù„Ù…Ù†ÙŠÙˆÙ…">Ø£Ù„Ù…Ù†ÙŠÙˆÙ…</option>
                        <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ù‚Ø§Ø³</label>
                    <input type="text" id="editSize" list="sizeSuggestions" required>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…ØªØ±)</label>
                    <input type="number" id="editMeters" min="0" step="0.1" required>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-outline" onclick="app.closeModal('editModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <h3 style="margin-bottom: 1rem;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p style="margin-bottom: 2rem; color: var(--text-muted);">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-outline" onclick="app.closeModal('confirmModal')">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        /**
         * Cable Warehouse Management System - LocalStorage Edition
         */
        
        window.app = (() => {
        
            const KEYS = {
                DATA: 'cwms_inventory_data',
                TRANSACTIONS: 'cwms_transactions_data'
            };
        
            const WAREHOUSES = {
                BENZINA: 'Ù…Ø®Ø²Ù† Ø¨Ù†Ø²ÙŠÙ†Ù‡',
                NEW: 'Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯',
                HAJJ: 'Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø¬'
            };
        
            const WAREHOUSE_KEYS = {
                'Ù…Ø®Ø²Ù† Ø¨Ù†Ø²ÙŠÙ†Ù‡': 'benzina',
                'Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯': 'new',
                'Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø¬': 'hajj'
            };
        
            // In-memory state mirroring LocalStorage
            let inventory = [];
            let transactions = [];
            let currentDeleteItem = null;
        
            // --- LocalStorage Helpers ---
        
            const loadData = () => {
                const storedInv = localStorage.getItem(KEYS.DATA);
                const storedTrans = localStorage.getItem(KEYS.TRANSACTIONS);
        
                if (storedInv) {
                    inventory = JSON.parse(storedInv);
                } else {
                    // Initialize Mock Data
                    inventory = [
                        { id: '1', warehouse: WAREHOUSES.BENZINA, type: 'Ù†Ø­Ø§Ø³', size: '16 Ù…Ù…', meters: 150, updatedAt: new Date().toISOString() },
                        { id: '2', warehouse: WAREHOUSES.BENZINA, type: 'Ø£Ù„Ù…Ù†ÙŠÙˆÙ…', size: '25 Ù…Ù…', meters: 400, updatedAt: new Date().toISOString() },
                        { id: '3', warehouse: WAREHOUSES.NEW, type: 'Ù†Ø­Ø§Ø³', size: '4 Ù…Ù…', meters: 30, updatedAt: new Date().toISOString() },
                        { id: '4', warehouse: WAREHOUSES.NEW, type: 'Ø¢Ø®Ø±', size: 'ÙƒÙŠØ¨Ù„ Ø´Ø¨ÙƒØ©', meters: 500, updatedAt: new Date().toISOString() },
                        { id: '5', warehouse: WAREHOUSES.HAJJ, type: 'Ø£Ù„Ù…Ù†ÙŠÙˆÙ…', size: '120 Ù…Ù…', meters: 1200, updatedAt: new Date().toISOString() }
                    ];
                    saveInventory();
                }
        
                if (storedTrans) {
                    transactions = JSON.parse(storedTrans);
                } else {
                    transactions = [];
                    saveTransactions();
                }
            };
        
            const saveInventory = () => localStorage.setItem(KEYS.DATA, JSON.stringify(inventory));
            const saveTransactions = () => localStorage.setItem(KEYS.TRANSACTIONS, JSON.stringify(transactions));
        
            const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        
            // --- UI Helpers ---
        
            const showToast = (msg, type = 'success') => {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = type === 'success' 
                    ? `<span style="color:var(--primary)">âœ“</span> ${msg}` 
                    : `<span style="color:var(--danger)">âš </span> ${msg}`;
                container.appendChild(toast);
        
                setTimeout(() => {
                    toast.style.animation = 'toastOut 0.3s forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };
        
            const showLoader = (key, show) => {
                const loader = document.getElementById(`loader-${key}`);
                if(loader) loader.style.display = show ? 'block' : 'none';
                const table = document.getElementById(`table-${key}`);
                if(table) table.style.opacity = show ? '0.5' : '1';
            };
        
            // --- Core Logic ---
        
            const init = () => {
                console.log("App Initializing (LocalStorage Mode)...");
                loadData();
                
                // Initialize default date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('issueDate').value = today;
                document.getElementById('reportDate').value = today;
        
                // Initial Render
                Object.keys(WAREHOUSE_KEYS).forEach(wh => renderTable(WAREHOUSE_KEYS[wh]));
            };
        
            const switchTab = (tabId) => {
                // Hide all sections
                document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                
                // Update Nav
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                // Find button that triggered this or match by text could be complex, 
                // simpler to rely on the fact that onclick passes control. 
                // We'll just iterate to find the matching onclick attribute for simplicity in this no-framework setup.
                const btns = document.querySelectorAll('.nav-btn');
                btns.forEach(btn => {
                   if(btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active');
                });
                
                if(tabId === 'issues') {
                    renderReport();
                }
            };
        
            const getFilteredData = (key) => {
                // Map key back to warehouse name
                const whName = Object.keys(WAREHOUSE_KEYS).find(k => WAREHOUSE_KEYS[k] === key);
                
                let data = inventory.filter(i => i.warehouse === whName);
                
                const searchInput = document.querySelector(`#${key} .search-bar input`)?.value.toLowerCase() || '';
                const typeFilter = document.querySelector(`#${key} .search-bar select`)?.value || 'all';
        
                return data.filter(item => {
                    const matchesSearch = (item.size || '').toLowerCase().includes(searchInput) || 
                                          (item.type || '').toLowerCase().includes(searchInput);
                    const matchesType = typeFilter === 'all' || item.type === typeFilter;
                    return matchesSearch && matchesType;
                });
            };
        
            const renderTable = (key) => {
                showLoader(key, true);
                
                // Simulate network delay for "feel"
                setTimeout(() => {
                    const tbody = document.querySelector(`#table-${key} tbody`);
                    if (!tbody) return;
        
                    const data = getFilteredData(key);
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem; color: var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</td></tr>';
                    } else {
                        tbody.innerHTML = data.map(item => {
                            let badgeClass = 'badge-cu';
                            if(item.type === 'Ø£Ù„Ù…Ù†ÙŠÙˆÙ…') badgeClass = 'badge-al';
                            else if(item.type === 'Ø¢Ø®Ø±') badgeClass = 'badge-al'; // gray for others
                            
                            let statusBadge = item.meters < 50 ? 
                                `<span class="badge badge-status-low">Ù…Ù†Ø®ÙØ¶</span>` : 
                                `<span class="badge badge-status-ok">Ø¬ÙŠØ¯</span>`;
        
                            return `
                                <tr>
                                    <td><span class="badge ${badgeClass}">${item.type}</span></td>
                                    <td style="font-weight:bold; direction: ltr;">${item.size}</td>
                                    <td>${parseFloat(item.meters).toFixed(1)} Ù…</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline" onclick="app.openEditModal('${item.id}')">âœï¸</button>
                                        <button class="btn btn-sm btn-outline" style="color:var(--danger)" onclick="app.openConfirmDelete('${item.id}')">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                    showLoader(key, false);
                }, 200);
            };
        
            const filterTable = (key) => {
                renderTable(key);
            };
        
            // --- Modal Operations ---
        
            const openAddModal = (warehouseName) => {
                document.getElementById('targetWarehouse').value = warehouseName;
                document.getElementById('addForm').reset();
                document.getElementById('addModal').classList.add('open');
            };
        
            const openEditModal = (id) => {
                const item = inventory.find(i => i.id === id);
                if(!item) return;
        
                document.getElementById('editWarehouse').value = item.warehouse;
                document.getElementById('editId').value = id;
                document.getElementById('editType').value = item.type;
                document.getElementById('editSize').value = item.size;
                document.getElementById('editMeters').value = item.meters;
                
                document.getElementById('editModal').classList.add('open');
            };
        
            const openConfirmDelete = (id) => {
                currentDeleteItem = id;
                document.getElementById('confirmModal').classList.add('open');
            };
        
            const closeModal = (modalId) => {
                document.getElementById(modalId).classList.remove('open');
                currentDeleteItem = null;
            };
        
            // --- CRUD Operations ---
        
            const handleAddSubmit = (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                btn.classList.add('btn-loading');
        
                setTimeout(() => {
                    const newItem = {
                        id: generateId(),
                        warehouse: document.getElementById('targetWarehouse').value,
                        type: document.getElementById('addType').value,
                        size: document.getElementById('addSize').value,
                        meters: parseFloat(document.getElementById('addMeters').value),
                        updatedAt: new Date().toISOString()
                    };
        
                    inventory.push(newItem);
                    saveInventory();
                    
                    renderTable(WAREHOUSE_KEYS[newItem.warehouse]);
                    showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                    closeModal('addModal');
                    btn.classList.remove('btn-loading');
                }, 400);
            };
        
            const handleEditSubmit = (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                btn.classList.add('btn-loading');
        
                setTimeout(() => {
                    const id = document.getElementById('editId').value;
                    const index = inventory.findIndex(i => i.id === id);
                    
                    if (index > -1) {
                        inventory[index].type = document.getElementById('editType').value;
                        inventory[index].size = document.getElementById('editSize').value;
                        inventory[index].meters = parseFloat(document.getElementById('editMeters').value);
                        inventory[index].updatedAt = new Date().toISOString();
                        
                        saveInventory();
                        renderTable(WAREHOUSE_KEYS[inventory[index].warehouse]);
                        showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        showToast('Ø®Ø·Ø£: Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                    }
        
                    closeModal('editModal');
                    btn.classList.remove('btn-loading');
                }, 400);
            };
        
            // Attach delete logic
            document.getElementById('confirmDeleteBtn').onclick = function() {
                if(!currentDeleteItem) return;
                const btn = this;
                btn.classList.add('btn-loading');
        
                setTimeout(() => {
                    const item = inventory.find(i => i.id === currentDeleteItem);
                    if (item) {
                        inventory = inventory.filter(i => i.id !== currentDeleteItem);
                        saveInventory();
                        renderTable(WAREHOUSE_KEYS[item.warehouse]);
                        showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
                    }
                    closeModal('confirmModal');
                    btn.classList.remove('btn-loading');
                }, 400);
            };
        
            // --- Issues & Reports ---
        
            const updateIssueItems = () => {
                const warehouse = document.getElementById('issueWarehouse').value;
                const select = document.getElementById('issueItemSelect');
                const amount = document.getElementById('issueAmount');
                
                select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --</option>';
                
                if(!warehouse) {
                    select.disabled = true;
                    amount.disabled = true;
                    return;
                }
        
                const items = inventory.filter(i => i.warehouse === warehouse);
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.type} - ${item.size} (Ù…ØªØ§Ø­: ${item.meters})`;
                    option.dataset.max = item.meters;
                    select.appendChild(option);
                });
        
                select.disabled = false;
                amount.disabled = false;
            };
        
            const handleIssueSubmit = (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                const warehouse = document.getElementById('issueWarehouse').value;
                const itemId = document.getElementById('issueItemSelect').value;
                const amount = parseFloat(document.getElementById('issueAmount').value);
                const recipient = document.getElementById('issueRecipient').value;
                const dateVal = document.getElementById('issueDate').value;
        
                // Validation
                const select = document.getElementById('issueItemSelect');
                const currentMax = parseFloat(select.options[select.selectedIndex]?.dataset.max || 0);
        
                if(amount > currentMax) {
                    showToast(`Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©. Ø§Ù„Ù…ØªØ§Ø­: ${currentMax}`, 'error');
                    return;
                }
        
                btn.classList.add('btn-loading');
        
                setTimeout(() => {
                    const itemIndex = inventory.findIndex(i => i.id === itemId);
                    
                    if (itemIndex > -1) {
                        // 1. Decrement Inventory
                        inventory[itemIndex].meters -= amount;
                        inventory[itemIndex].updatedAt = new Date().toISOString();
        
                        // 2. Add Transaction
                        const transaction = {
                            id: generateId(),
                            warehouse,
                            itemId,
                            itemType: inventory[itemIndex].type,
                            itemSize: inventory[itemIndex].size,
                            amount,
                            recipient,
                            date: new Date(dateVal).toISOString() // Store ISO for consistency
                        };
                        transactions.push(transaction);
        
                        saveInventory();
                        saveTransactions();
                        
                        // Update tables in background if visible
                        renderTable(WAREHOUSE_KEYS[warehouse]);
                        
                        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­');
                        e.target.reset();
                        // Reset date to today
                        document.getElementById('issueDate').value = new Date().toISOString().split('T')[0];
                        updateIssueItems();
                    } else {
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                    
                    btn.classList.remove('btn-loading');
                }, 500);
            };
        
            const renderReport = () => {
                const dateInput = document.getElementById('reportDate').value; // YYYY-MM-DD
                if(!dateInput) return;
        
                // Print header update
                document.getElementById('printDateDisplay').textContent = `ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…: ${dateInput}`;
        
                const loader = document.getElementById('loader-report');
                const tbody = document.getElementById('reportTableBody');
                const totalEl = document.getElementById('reportTotal');
        
                loader.style.display = 'block';
                tbody.innerHTML = '';
                totalEl.textContent = '...';
        
                setTimeout(() => {
                    const filtered = transactions.filter(t => {
                        return t.date.startsWith(dateInput);
                    }).sort((a,b) => new Date(b.date) - new Date(a.date));
        
                    let totalMeters = 0;
                    
                    if(filtered.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 1rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</td></tr>';
                    } else {
                        tbody.innerHTML = filtered.map(t => {
                            totalMeters += t.amount;
                            // For simplicity, we just show the date since time isn't captured in the date input, 
                            // but in a real app we'd capture time. We'll show "DD/MM/YYYY" or just "ØªÙ…"
                            return `
                                <tr>
                                    <td>${t.warehouse}</td>
                                    <td>${t.recipient}</td>
                                    <td>${t.itemType} - ${t.itemSize}</td>
                                    <td style="font-weight:bold; direction:ltr">${t.amount}</td>
                                    <td>${t.date.split('T')[0]}</td> 
                                </tr>
                            `;
                        }).join('');
                    }
                    
                    totalEl.textContent = totalMeters.toFixed(1) + ' Ù…ØªØ±';
                    loader.style.display = 'none';
                }, 300);
            };
        
            // Expose public interface
            return {
                init,
                switchTab,
                filterTable,
                openAddModal,
                openEditModal,
                openConfirmDelete,
                closeModal,
                handleAddSubmit,
                handleEditSubmit,
                handleIssueSubmit,
                updateIssueItems,
                renderReport
            };
        })();
        
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>

